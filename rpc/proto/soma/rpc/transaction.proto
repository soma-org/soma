syntax = "proto3";

package soma.rpc;

import "google/protobuf/duration.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "soma/rpc/object.proto";
import "soma/rpc/object_reference.proto";

// A transaction.
message Transaction {

  // The digest of this Transaction.
  optional string digest = 1;

  optional TransactionKind kind = 2;
  optional string sender = 3;
  repeated ObjectReference gas_payment = 4;
}

// Transaction type.
message TransactionKind {
  oneof kind {
    // Transaction used to initialize the chain state.
    //
    // Only valid if in the genesis checkpoint (0) and if this is the very first transaction ever
    // executed on the chain.
    GenesisTransaction genesis = 1;

    // Consensus commit update.
    ConsensusCommitPrologue consensus_commit_prologue = 2;

    // System transaction used to end an epoch..
    ChangeEpoch change_epoch = 3;

    AddValidator add_validator = 4;

    RemoveValidator remove_validator = 5;

    ReportValidator report_validator = 6;

    UndoReportValidator undo_report_validator = 7;

    UpdateValidatorMetadata update_validator_metadata = 8;

    SetCommissionRate set_commission_rate = 9;

    TransferCoin transfer_coin = 10;

    PayCoins pay_coins = 11;

    TransferObjects transfer_objects = 12;

    AddStake add_stake = 13;

    WithdrawStake withdraw_stake = 14;
  }
}

message AddValidator {
  optional bytes pubkey_bytes = 1;
  optional bytes network_pubkey_bytes = 2;
  optional bytes worker_pubkey_bytes = 3;
  optional bytes net_address = 4;
  optional bytes p2p_address = 5;
  optional bytes primary_address = 6;
}

message RemoveValidator {
  optional bytes pubkey_bytes = 1;
}

message ReportValidator {
  optional string reportee = 1;
}

message UndoReportValidator {
  optional string reportee = 1;
}

message UpdateValidatorMetadata {
  optional bytes next_epoch_network_address = 1;
  optional bytes next_epoch_p2p_address = 2;
  optional bytes next_epoch_primary_address = 3;
  optional bytes next_epoch_protocol_pubkey = 4;
  optional bytes next_epoch_worker_pubkey = 5;
  optional bytes next_epoch_network_pubkey= 6;
}

message SetCommissionRate {
  optional uint64 new_rate = 1;
}

message TransferCoin {
  optional ObjectReference coin = 1;
  optional uint64 amount = 2;
  optional string recipient = 3;
}

message PayCoins {
  repeated ObjectReference coins = 1;
  repeated uint64 amounts = 2;
  repeated string recipients = 3;
}

message TransferObjects {
  repeated ObjectReference objects = 1;
  optional string recipient = 2;
}

message AddStake {
  optional string address = 1;
  optional ObjectReference coin_ref = 2;
  optional uint64 amount = 3;
}


message WithdrawStake {
  optional ObjectReference staked_soma = 1;
}

message Metadata {
  oneof version {
    MetadataV1 v1 = 1;
  }
}

message MetadataV1 {
  optional bytes checksum = 1;  // 32-byte digest
  optional uint64 size = 2;      // Size in bytes
}

message DefaultDownloadMetadataV1 {
  optional string url = 1;
  optional Metadata metadata = 2;
}

message DefaultDownloadMetadata {
  oneof version {
    DefaultDownloadMetadataV1 v1 = 1;
  }
}

message MtlsDownloadMetadataV1 {
  optional bytes peer = 1;  // NetworkPublicKey bytes
  optional string url = 2;
  optional Metadata metadata = 3;
}

message MtlsDownloadMetadata {
  oneof version {
    MtlsDownloadMetadataV1 v1 = 1;
  }
}

message DownloadMetadata {
  oneof kind {
    DefaultDownloadMetadata default = 1;
    MtlsDownloadMetadata mtls = 2;
  }
}



// System transaction used to change the epoch.
message ChangeEpoch {
  // The next (to become) epoch ID.
  optional uint64 epoch = 1;

  // Unix timestamp when epoch started.
  optional google.protobuf.Timestamp epoch_start_timestamp = 2;

  // The protocol version in effect in the new epoch.
  optional uint64 protocol_version = 3;

  // The total amount of fees charged during the epoch.
  optional uint64 fees = 4;

  /// Epoch randomness
  optional bytes epoch_randomness = 5;
}


// The genesis transaction.
message GenesisTransaction {
  // Set of genesis objects.
  repeated Object objects = 1;
}

// Consensus commit prologue system transaction.
message ConsensusCommitPrologue {
  // Epoch of the commit prologue transaction.
  optional uint64 epoch = 1;

  // Consensus round of the commit.
  optional uint64 round = 2;

  // The sub DAG index of the consensus commit. This field is populated if there
  // are multiple consensus commits per round.
  optional uint64 sub_dag_index = 3;

  // Unix timestamp from consensus.
  optional google.protobuf.Timestamp commit_timestamp = 4;

  // Digest of consensus output.
  optional string consensus_commit_digest = 5;

  // Digest of any additional state computed by the consensus handler.
  // Used to detect forking bugs as early as possible.
  optional string additional_state_digest = 6;
}
